# Project Scanner - 仕様書・要件定義

作成日: 2026-01-05
バージョン: 0.14
作成者: Claude Code

---

## 1. 概要

### 1.1 本質的な目的（最重要）

**「正しい正確な状況把握」を実現するツール**

#### なぜこのツールが必要か

AIエージェントが「作りました」と報告しても、実際は嘘やダミーの場合がある。

**具体的な問題ケース:**

| ケース | 説明 |
|--------|------|
| 空ファイル | 中身空っぽのまま「完成しました」と報告 |
| ダミーファイル | 形だけ作ってコンテンツなし |
| コピー詐欺 | 「20個作って」→ 同じファイルを20個コピーしただけ |
| 偽装 | ファイル名だけ違って中身は同一 |

**だからこそ必要:**
- AIの報告を**検証**できる仕組み
- **ダミー発見機能**
- 目視確認なしでも**信頼できる状況把握**

### 1.2 利用シーン

| シーン | 説明 |
|--------|------|
| 新規プロジェクト理解 | 初めて見るプロジェクトの全体像を把握 |
| LLMへの入力準備 | プロジェクト情報をLLMに渡すための前処理 |
| ドキュメント生成 | プロジェクトの概要ドキュメントを自動生成 |
| コードレビュー補助 | レビュー前にプロジェクト構造を確認 |
| **AI出力の検証** | AIが作成したと報告するファイルの実態確認 |

---

## 2. 機能要件

### 2.1 コア機能（実装済み）

#### 2.1.1 プロジェクトスキャン
- 指定フォルダ配下の全ファイル・フォルダを再帰的に取得
- 自動除外対象:
  - `.git`, `.svn`, `.hg`
  - `node_modules`, `__pycache__`, `.venv`, `venv`
  - `.idea`, `.vscode`, `.vs`
  - `dist`, `build`, `target`, `bin`, `obj`

#### 2.1.2 統計情報収集
- フォルダ数
- ファイル数
- 総行数
- 拡張子別ファイル数
- 各ファイルのサイズ（bytes）

#### 2.1.3 ファイル内容抽出
- 各ファイルの先頭N行（デフォルト: 3行）
- 各ファイルの末尾N行（デフォルト: 3行）
- 空行スキップオプション（デフォルト: ON）

#### 2.1.4 コード解析（Python）
- 関数定義の抽出（`def`, `async def`）
- クラス定義の抽出（`class`）
- AST（抽象構文木）を使用した静的解析

#### 2.1.5 HTMLレポート出力
- **概要レポート（index.html）**
  - サマリーカード（フォルダ数、ファイル数、行数等）
  - 拡張子別統計テーブル
  - ファイル一覧テーブル
  - 関数一覧テーブル
  - クラス一覧テーブル
- **詳細レポート（detail.html）**
  - 各ファイルの先頭/末尾行
  - 各ファイルの関数・クラス一覧

#### 2.1.6 ファイル結合（Concat）
- 拡張子別にファイルを結合
- 出力形式: `all_{拡張子}.{拡張子}`
- 各ファイルの区切りヘッダー付き

#### 2.1.7 ダミー検出機能（v0.13で実装）

**本ツールの核心機能。AIが作成したファイルの実態を検証する。**

| 検出パターン | 説明 | 実装方法 |
|-------------|------|---------|
| 空ファイル検出 | 0バイトまたは極端に小さいファイル（10bytes以下） | サイズチェック |
| 同一サイズ検出 | 複数ファイルが完全に同じサイズ（3ファイル以上） | サイズでグループ化 |
| 同一タイムスタンプ検出 | 同じ時刻に作成されたファイル群（3ファイル以上） | mtime比較 |
| ハッシュ重複検出 | 内容が完全に同一のファイル | MD5ハッシュ |

**レポート出力:**
- 警告セクションをHTMLレポートに追加（黄色背景）
- 重複グループを一覧表示

---

### 2.2 追加予定機能（未実装）

#### 2.2.1 除外パターンのカスタマイズ【優先度: 高】
- `.gitignore`形式での除外パターン指定
- コマンドラインオプション: `--exclude`, `--exclude-file`
- 設定ファイルでの指定

#### 2.2.2 設定ファイル対応【優先度: 高】
- ファイル名: `.project-scanner.json` または `.project-scanner.yaml`
- プロジェクトごとに設定を保存
- コマンドラインオプションで上書き可能

```json
{
  "head_lines": 5,
  "tail_lines": 5,
  "exclude": ["*.log", "tmp/"],
  "output": "./reports",
  "concat": {
    "enabled": true,
    "output": "./",
    "extensions": [".py", ".js"]
  }
}
```

#### 2.2.3 Concat出力先の変更【優先度: 中】
- 現在: `output/concat/`
- 変更: 元プロジェクト内に出力
- オプション: `--concat-output`

#### 2.2.4 JavaScript/TypeScript関数抽出【優先度: 中】
- `function`, `const xxx = () =>`, `class` の抽出
- パーサー: 正規表現 or tree-sitter

#### 2.2.5 Markdown出力【優先度: 低】
- HTML以外にMarkdown形式でも出力
- LLMへの入力に適した形式

#### 2.2.6 LLM用メタ情報出力【優先度: 中】
- プロジェクト構造のサマリー（テキスト形式）
- ファイル一覧 + 概要（JSON/YAML形式）
- Concat + メタ情報のセット出力

---

## 3. 非機能要件

### 3.1 パフォーマンス
- 1万ファイル規模のプロジェクトを1分以内にスキャン
- メモリ使用量: 1GB未満

### 3.2 互換性
- Python 3.8以上
- Windows / macOS / Linux対応
- 外部依存なし（標準ライブラリのみ）

### 3.3 エンコーディング
- UTF-8優先
- フォールバック: UTF-8-sig → CP932 → Shift_JIS → Latin-1

### 3.4 エラーハンドリング
- 読み取りエラーは無視して続行
- バイナリファイルは行数カウントをスキップ

---

## 4. インターフェース

### 4.1 コマンドライン

```bash
# 基本
python scanner.py <path>

# オプション
python scanner.py <path> \
  --output ./reports \
  --head 5 \
  --tail 5 \
  --concat \
  --concat-ext .py .js \
  --exclude "*.log" "tmp/"
```

### 4.2 オプション一覧

| オプション | 説明 | デフォルト | 状態 |
|-----------|------|-----------|------|
| `path` | スキャン対象フォルダ | (必須) | ✅ |
| `--output`, `-o` | 出力先フォルダ | `./output` | ✅ |
| `--head` | 先頭行数 | 3 | ✅ |
| `--tail` | 末尾行数 | 3 | ✅ |
| `--concat` | ファイル結合有効化 | disabled | ✅ |
| `--concat-ext` | 結合対象拡張子 | all | ✅ |
| `--concat-output` | 結合ファイル出力先 | output/concat | 🔜 |
| `--exclude` | 除外パターン | - | 🔜 |
| `--exclude-file` | 除外パターンファイル | - | 🔜 |
| `--config` | 設定ファイルパス | - | 🔜 |
| `--format` | 出力形式 (html/md/both) | html | 🔜 |

---

## 5. 出力ファイル構成

```
output/
├── index.html      # 概要レポート
├── detail.html     # 詳細レポート
├── concat/         # 結合ファイル
│   ├── all_py.py
│   ├── all_js.js
│   └── ...
└── meta/           # LLM用メタ情報（将来）
    ├── summary.txt
    └── structure.json
```

---

## 6. 技術的判断ログ

| 判断 | 理由 | 日付 |
|------|------|------|
| Sphinx不使用 | conf.py必須、import必須で重い。ASTの方がシンプル | 2026-01-05 |
| Python AST採用 | import不要で静的解析可能、軽量 | 2026-01-05 |
| HTML優先 | ブラウザで即確認可能、視認性が高い | 2026-01-05 |

---

## 7. バージョン履歴

| バージョン | 日付 | 変更内容 |
|-----------|------|---------|
| 0.1 | 2026-01-05 | 初期リリース |
| 0.11 | 2026-01-05 | 開発ルール追加、仕様書作成 |
| 0.12 | 2026-01-05 | 開発ルールテンプレート作成 |
| 0.13 | 2026-01-05 | ダミー検出機能実装（空ファイル、同一サイズ、同一タイムスタンプ、ハッシュ重複） |
| 0.14 | 2026-01-05 | コンソール出力のエンコーディングエラー修正 |

---

## 8. 今後のロードマップ

### Phase 1（次回実装予定）
- [ ] 除外パターンカスタマイズ
- [ ] 設定ファイル対応
- [ ] Concat出力先変更

### Phase 2
- [ ] JavaScript/TypeScript関数抽出
- [ ] Markdown出力
- [ ] LLM用メタ情報出力

### Phase 3
- [ ] GUI版（Electron or Web）
- [ ] VS Code拡張
